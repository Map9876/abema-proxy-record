name: VNC with Firefox and Cloudflared

on: [push]

jobs:
  setup-vnc:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. 安装依赖
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget

      # 3. 配置VNC
      - name: Configure VNC
        run: |
          mkdir ~/clash; cd ~/clash
          wget https://github.com/DustinWin/proxy-tools/releases/download/Clash-Premium/clashpremium-nightly-linux-amd64-v3.tar.gz
          tar -xvf clashpremium-nightly-linux-amd64-v3.tar.gz
          mv CrashCore clash
          wget -q -O config.yaml "https://subconverters.com/sub?target=clash&url=${{ secrets.URL_PROXY }}&extend=1&insert=false&config=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Full_NoAuto.ini&emoji=true&list=false&xudp=false&udp=false&tfo=false&expand=true&scv=false&fdn=false&new_name=true"
          
          chmod +x clash
          ./clash -d .
          export HTTP_PROXY='http://127.0.0.1:7890'
          export HTTPS_PROXY='http://127.0.0.1:7890'
          export ALL_PROXY='socks5://127.0.0.1:7891'
          


      # 7. 安装Cloudflared
      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      # 8. 启动Cloudflared隧道（TCP模式）
      - name: Start Cloudflared tunnel (TCP mode)
        run: |
          cloudflared tunnel --url tcp://localhost:5901 > cloudflared.log 2>&1 &
          sleep 5  # 等待Cloudflared启动
          echo "Cloudflared tunnel started. Check the log for the public URL."

      # 9. 输出Cloudflared日志
      - name: Output Cloudflared log
        run: |
          cat cloudflared.log

      # 10. 保持运行
      - name: Keep running
        run: |
          sleep 3000
